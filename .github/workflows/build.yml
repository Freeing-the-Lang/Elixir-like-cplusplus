name: "Elixir-like-cplusplus — 3OS Build + ProofLedger + Output"

on:
  push:
    branches: [ main ]
  workflow_dispatch:

permissions:
  contents: write

concurrency:
  group: elixir-like-cplusplus-${{ github.ref }}
  cancel-in-progress: true

jobs:
  build-3os:
    name: "Build — ${{ matrix.os }}"
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        os: [ubuntu-latest, macos-latest, windows-latest]

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # -------------------------------
      # C++ Build Environment
      # -------------------------------
      - name: Setup C++ compiler on Windows
        if: matrix.os == 'windows-latest'
        uses: microsoft/setup-msbuild@v2

      - name: Setup C++ compiler on Linux/macOS
        if: matrix.os != 'windows-latest'
        run: |
          sudo apt update || true
          sudo apt install -y g++ || true

      # -------------------------------
      # Build the project
      # -------------------------------
      - name: Build
        run: |
          mkdir -p build
          cd build
          g++ ../src/*.cpp -std=c++17 -o elixir_cpp

      # -------------------------------
      # Run example.elx
      # -------------------------------
      - name: Run example
        run: |
          cd build
          echo "### Running example.elx ###"
          ./elixir_cpp || .\elixir_cpp.exe

      # -------------------------------
      # Create output text (generated C++)
      # -------------------------------
      - name: Capture generated C++ output
        run: |
          cd build
          ./elixir_cpp > out_cpp.txt || .\elixir_cpp.exe > out_cpp.txt

      # -------------------------------
      # ProofLedger
      # -------------------------------
      - name: Generate ProofLedger
        run: |
          echo "Repository: Elixir-like-cplusplus"            >  proofledger-${{ matrix.os }}-${{ github.ref_name }}.txt
          echo "Commit: ${{ github.sha }}"                    >> proofledger-${{ matrix.os }}-${{ github.ref_name }}.txt
          echo "OS: ${{ matrix.os }}"                          >> proofledger-${{ matrix.os }}-${{ github.ref_name }}.txt
          echo "Build Time: $(date)"                           >> proofledger-${{ matrix.os }}-${{ github.ref_name }}.txt
          echo "Generated File: out_cpp.txt"                   >> proofledger-${{ matrix.os }}-${{ github.ref_name }}.txt

      # -------------------------------
      # Upload Artifacts
      # -------------------------------
      - name: Upload output
        uses: actions/upload-artifact@v4
        with:
          name: out-cpp-${{ matrix.os }}-${{ github.ref_name }}
          path: build/out_cpp.txt

      - name: Upload ProofLedger
        uses: actions/upload-artifact@v4
        with:
          name: proofledger-${{ matrix.os }}-${{ github.ref_name }}
          path: proofledger-${{ matrix.os }}-${{ github.ref_name }}.txt
